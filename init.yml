 - hosts: all
   remote_user: root
   vars:
   - venv_path: /home/sproutwave/sproutwave_venv
   - code_path: /home/sproutwave/sproutwave_node
   - sproutwave_user: sproutwave
   tasks:
   - user: name=sproutwave state=present shell=/bin/bash
   - name: aptitude
     apt: name=aptitude state=installed
   - name: apt-get update && apt-get upgrade
     apt: update_cache=yes upgrade=yes
   - name: install list of packages
     apt: name={{item}} state=installed
     with_items:
      - python3
      - python3-dev
      - python3-venv
      - python3-wheel
      - python3-numpy
      - python3-pip
      - build-essential
      - cmake # building librtlsdr
      - libuv-dev
      - libffi-dev
      - libudev-dev #libusb-dev installed
      #- librtlsdr-dev # install from source
      - redis-server
      - screen
      - git
      - bc
      - psutils
      - rsync
   - name: enable sproutwave_admin.pub for root
     authorized_key:
       user: root
       state: present
       key: '{{ item }}'
     with_file:
       - sproutwave_admin.pub
   - name: enable sproutwave_admin.pub for sproutwave
     authorized_key:
       user: '{{sproutwave_user}}'
       state: present
       key: '{{ item }}'
     with_file:
       - sproutwave_admin.pub
   - name: install redis config
     copy: src=./redis.conf dest=/etc/redis/redis.conf owner=redis
   - name: restart redis
     service: name=redis state=restarted
   - name: build python venv
     command: pyvenv-3.5 --clear {{venv_path}}
     become: true
     become_user: sproutwave
   - name: build python venv
     command: pyvenv-3.5 --system-site-packages {{venv_path}}
     become: true
     become_user: sproutwave
   - name: checkout git
     synchronize: src=../swbs/ dest={{code_path}} #owner={{sproutwave_user}}
     become: true
     become_user: sproutwave
   - name: set permissions
     file: dest={{code_path}} owner={{sproutwave_user}} group={{sproutwave_user}} recurse=yes
   - name: install python requirements
     pip: requirements={{code_path}}/requirements.txt virtualenv={{venv_path}}
     become: true
     become_user: sproutwave
   - name: launch session
     shell: screen -d -m {{venv_path}}/bin/python {{code_path}}/phase1.py
     become: true
     become_user: sproutwave
